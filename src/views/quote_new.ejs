<%- include('partials_header', { title: pageTitle || 'New Quote', company }) %>

<section class="card">
  <h1><%= pageTitle || 'New Quotation' %></h1>
  <form id="quote-form" method="POST" action="<%= basePath %><%= formAction || '/quotes' %>">
    <div class="grid">
      <label>
        Quote Date
        <input type="date" name="quote_date" value="<%= quote?.quote_date_display || '' %>" required />
      </label>
      <label>
        Customer Name
        <input type="text" name="customer_name" value="<%= quote?.customer_name || '' %>" required placeholder="Customer name" />
      </label>
      <label>
        Phone
        <input type="text" name="customer_phone" value="<%= quote?.customer_phone || '' %>" placeholder="Phone number" />
      </label>
      <label>
        Email
        <input type="email" name="customer_email" value="<%= quote?.customer_email || '' %>" placeholder="Email" />
      </label>
      <label class="span-2">
        Address
        <textarea name="customer_address" rows="2" placeholder="Customer address"><%= quote?.customer_address || '' %></textarea>
      </label>
      <label>
        GSTIN
        <input type="text" name="customer_gstin" value="<%= quote?.customer_gstin || '' %>" placeholder="Customer GSTIN" />
      </label>
    </div>

    <h2>Items</h2>
    <div class="table-wrap">
      <table id="items-table">
        <thead>
          <tr>
            <th>Product</th>
            <th>Item / Description</th>
            <th>HSN</th>
            <th>Unit</th>
            <th>Qty</th>
            <th>Rate</th>
            <th>GST %</th>
            <th>Taxable</th>
            <th>CGST</th>
            <th>SGST</th>
            <th>Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <button type="button" id="add-item" class="btn-secondary">+ Add Item</button>

    <div class="summary">
      <div>Subtotal: <span id="subtotal">0.00</span></div>
      <div>CGST: <span id="cgst-total">0.00</span></div>
      <div>SGST: <span id="sgst-total">0.00</span></div>
      <div class="grand">Grand Total: <span id="grand-total">0.00</span></div>
    </div>

    <h2>ITEMS CONSIDERED FOR PROPOSAL</h2>
    <div class="table-wrap proposal-wrap">
      <table id="proposal-items-table">
        <thead>
          <tr>
            <th>Sr.no</th>
            <th>Description</th>
            <th>Unit</th>
            <th>Qty.</th>
            <th>Specification</th>
            <th>Make</th>
          </tr>
        </thead>
        <tbody>
          <% const fallbackRows = [
            { sr_no: 1, description: 'Solar PV Modules - (Module Size having +-05 Wp variation)', unit: 'Nos', qty: '5', specification: '620', make: 'ADANI' },
            { sr_no: 2, description: 'Module mounting structure', unit: 'Set', qty: 'As per design', specification: 'As per design', make: 'Hot Dip Galv. Iron 60x40 & 40x40' },
            { sr_no: 3, description: 'String type Grid Tied Inverter as per availability', unit: 'Nos', qty: '1', specification: 'As per design', make: 'SOLARYAAN / XWATT' },
            { sr_no: 4, description: 'DCDB with accessories', unit: 'Nos', qty: 'As per design', specification: 'As per design', make: 'L&T/HAVELLS' },
            { sr_no: 5, description: 'ACDB with accessories', unit: 'Nos', qty: 'At actual', specification: 'As per design', make: 'L&T/HAVELLS' },
            { sr_no: 6, description: 'DC Wire with UV protected - TUV Certified', unit: 'Mtr.', qty: 'At actual', specification: 'As per design', make: 'POLYCAB' },
            { sr_no: 7, description: 'AC Wire - TUV Certified', unit: 'Mtr.', qty: 'At actual', specification: 'As per design', make: 'POLYCAB' },
            { sr_no: 8, description: 'Advanced Chemical Earthing systems', unit: 'Nos', qty: 'As per design', specification: 'As per design', make: 'Standard' },
            { sr_no: 9, description: 'Lightening arrester', unit: 'Nos', qty: 'As per design', specification: 'As per design', make: 'Standard' }
          ]; %>
          <% const proposalRows = (initialProposalItems && initialProposalItems.length)
            ? initialProposalItems
            : ((company && Array.isArray(company.proposalTemplate) && company.proposalTemplate.length)
              ? company.proposalTemplate
              : fallbackRows); %>
          <% proposalRows.forEach((item, idx) => { %>
            <tr>
              <td>
                <input type="text" class="proposal-sr-no" value="<%= item.sr_no || '' %>" />
              </td>
              <td>
                <input type="text" class="proposal-description" value="<%= item.description || '' %>" />
              </td>
              <td>
                <input type="text" class="proposal-unit" value="<%= item.unit || '' %>" />
              </td>
              <td>
                <input type="text" class="proposal-qty" value="<%= item.qty || '' %>" />
              </td>
              <td>
                <input type="text" class="proposal-specification" value="<%= item.specification || '' %>" />
              </td>
              <td>
                <input type="text" class="proposal-make" value="<%= item.make || '' %>" />
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <button type="button" id="add-proposal-item" class="btn-secondary">+ Add Proposal Row</button>

    <label class="notes">
      Notes / Terms (Optional)
      <textarea name="notes" rows="2" placeholder="Any extra notes or terms"><%= quote?.notes || '' %></textarea>
    </label>

    <input type="hidden" name="items_json" id="items-json" />
    <input type="hidden" name="proposal_items_json" id="proposal-items-json" />
    <button type="submit" class="btn-primary"><%= submitLabel || 'Save & Download PDF' %></button>
  </form>
</section>

<script>
  window.PRESET_PRODUCTS = <%- JSON.stringify(products || []) %>;
  window.INITIAL_QUOTE_ITEMS = <%- JSON.stringify(initialItems || []) %>;
  window.INITIAL_PROPOSAL_ITEMS = <%- JSON.stringify(initialProposalItems || []) %>;
</script>

<%- include('partials_footer') %>
